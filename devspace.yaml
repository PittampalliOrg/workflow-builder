# DevSpace Configuration for Workflow Builder
# Self-contained configuration for Kubernetes-native development with hot-reload
#
# Architecture:
#   - Replaces production container with devcontainer (full build tools)
#   - Syncs local files to container in real-time
#   - Runs Next.js dev server with hot module replacement
#   - Integrates with existing OTEL observability stack
#
# Usage:
#   devspace dev       # Start development mode
#   devspace enter     # Shell into container
#   devspace purge     # Clean up devspace resources

version: v2beta1
name: workflow-builder

# ============================================================================
# Variables
# ============================================================================
vars:
  # Application configuration
  APP_NAME: workflow-builder
  LOCAL_PORT: "3002"
  CONTAINER_PORT: "3000"
  SSH_PORT: 2223

  # Registry configuration
  GITEA_HOST:
    default: "gitea.cnoe.localtest.me:8443"
  GITEA_USER:
    default: "giteaadmin"

  # Resource configuration
  CPU_REQUEST:
    default: "500m"
  CPU_LIMIT:
    default: "4"
  MEMORY_REQUEST:
    default: "2Gi"
  MEMORY_LIMIT:
    default: "8Gi"

  # Observability
  OTEL_SERVICE_NAME:
    default: "${APP_NAME}-dev"
  OTEL_ENVIRONMENT:
    default: "development"

  # Next.js / pnpm configuration
  PNPM_VERSION:
    default: "9.12.3"

  # Database migrations
  RUN_MIGRATIONS:
    # Migrations are executed via GitOps (ArgoCD hook job) in this stack.
    default: "false"
  MIGRATION_COMMAND:
    default: "pnpm db:migrate"

  # Query currently deployed image tag from Kubernetes
  CURRENT_IMAGE_TAG:
    command: |
      kubectl get deployment ${APP_NAME} -n ${APP_NAME} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null |
      sed 's/.*://' || echo "latest"
    default: "latest"

  CURRENT_PRODUCTION_IMAGE:
    command: |
      kubectl get deployment ${APP_NAME} -n ${APP_NAME} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null ||
      echo "${GITEA_HOST}/${GITEA_USER}/${APP_NAME}:latest"
    default: "${GITEA_HOST}/${GITEA_USER}/${APP_NAME}:latest"

# ============================================================================
# Development Configuration
# ============================================================================
dev:
  app:
    # Target the deployment by image selector
    namespace: ${APP_NAME}
    imageSelector: ${GITEA_HOST}/${GITEA_USER}/${APP_NAME}
    container: ${APP_NAME}

    # Use shared devcontainer (instead of per-app image)
    devImage: ${GITEA_HOST}/${GITEA_USER}/nodejs-22-devspace:latest
    workingDir: /app

    # Resource requirements for development
    resources:
      requests:
        cpu: ${CPU_REQUEST}
        memory: ${MEMORY_REQUEST}
      limits:
        cpu: ${CPU_LIMIT}
        memory: ${MEMORY_LIMIT}

    # Command to run in the container
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo "=== DevSpace Development Container (Workflow Builder) ==="
        echo "Replacing production image: ${CURRENT_PRODUCTION_IMAGE}"
        echo "Using shared devcontainer: nodejs-22-devspace"
        echo ""

        # Always enable corepack and pnpm (required even if node_modules cached)
        echo "Enabling corepack and pnpm..."
        corepack enable
        corepack prepare pnpm@${PNPM_VERSION} --activate

        echo "Checking dependencies..."
        if [ ! -d "node_modules" ] || [ ! -f "node_modules/.pnpm-lock-hash" ] || \
           [ "$(cat node_modules/.pnpm-lock-hash 2>/dev/null)" != "$(md5sum pnpm-lock.yaml | cut -d' ' -f1)" ]; then
          echo "Installing dependencies..."
          pnpm install --frozen-lockfile
          md5sum pnpm-lock.yaml | cut -d' ' -f1 > node_modules/.pnpm-lock-hash
        else
          echo "Dependencies up to date (cached)"
        fi

        # Run database migrations (idempotent - only applies pending migrations)
        if [ "${RUN_MIGRATIONS}" = "true" ]; then
          echo "Running database migrations..."
          ${MIGRATION_COMMAND} || echo "Migrations skipped (database may not be ready)"
        fi

        # Add node_modules/.bin to PATH
        export PATH="/app/node_modules/.bin:$PATH"

        echo "Starting Next.js development server with Turbo..."
        exec next dev --turbo

    # File synchronization
    sync:
      - path: ./:/app
        initialSync: mirrorLocal
        startContainer: true
        waitInitialSync: true
        onUpload:
          restartContainer: false
          exec:
            - name: install-dependencies
              command: sh
              args:
                - -lc
                - cd /app && pnpm install --frozen-lockfile
              failOnError: true
              onChange:
                - package.json
                - pnpm-lock.yaml
        excludePaths:
          # Node.js / Next.js artifacts
          - node_modules/
          - .pnpm-store/
          - .next/
          - dist/
          - out/
          - coverage/
          - next-env.d.ts
          # Dev tooling
          - .devenv/
          - .devspace/
          - .direnv/
          - .git
          - .git/
          - .github/
          - .idea/
          - .vscode/
          - .cursor/
          # Test files
          - tests/
          - playwright-report/
          - test-results/
          - playwright.config.ts
          - vitest.config.ts
          # Docs & config
          - docs/
          - "*.md"
          - "*.log"
          - LICENSE
          - Dockerfile
          - Dockerfile.devspace
          - devenv.*
          - devenv.lock
          - .devenv*
          - .devenv.flake.nix
          - biome.jsonc
          - .dockerignore
          - .gitignore
          - .env.local
          - .env.example
          # Service subprojects (separate deployments)
          - services/

    # Patches to configure the pod for development
    patches:
      - op: remove
        path: spec.containers.name=${APP_NAME}.livenessProbe
      - op: remove
        path: spec.containers.name=${APP_NAME}.readinessProbe
      - op: replace
        path: spec.containers.name=${APP_NAME}.securityContext
        value:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          allowPrivilegeEscalation: false
      - op: replace
        path: spec.securityContext
        value:
          fsGroup: 1001
          runAsNonRoot: false

    # Port forwarding for development
    ports:
      - port: "${LOCAL_PORT}:${CONTAINER_PORT}"

    # SSH access for debugging
    ssh:
      enabled: true
      localPort: 2223

    # Environment variables for development
    env:
      - name: NODE_ENV
        value: development
      - name: NEXT_TELEMETRY_DISABLED
        value: "1"
      - name: OTEL_SERVICE_NAME
        value: ${OTEL_SERVICE_NAME}
      - name: OTEL_RESOURCE_ATTRIBUTES
        value: "deployment.environment=${OTEL_ENVIRONMENT},service.namespace=${APP_NAME}-dev,service.version=dev"
      - name: JAEGER_QUERY_SERVICE
        value: ${OTEL_SERVICE_NAME}
      - name: JAEGER_QUERY_URL
        value: "http://jaeger-query.observability.svc.cluster.local:16686"
      # Dapr sidecar configuration (for SDK access to config/secrets)
      - name: DAPR_HTTP_PORT
        value: "3500"
      - name: DAPR_GRPC_PORT
        value: "50001"
      - name: DAPR_SECRETS_STORE
        value: "azure-keyvault"
      - name: DAPR_CONFIG_STORE
        value: "azureappconfig-workflow-builder"
      - name: CONFIG_LABEL
        value: "workflow-builder"
      # Fallback URLs (Dapr SDK will override if available)
      - name: DAPR_ORCHESTRATOR_URL
        value: "http://workflow-orchestrator.workflow-builder.svc.cluster.local:8080"
      - name: GENERIC_ORCHESTRATOR_URL
        value: "http://workflow-orchestrator.workflow-builder.svc.cluster.local:8080"
      - name: WORKFLOW_ORCHESTRATOR_URL
        value: "http://workflow-orchestrator.workflow-builder.svc.cluster.local:8080"
      # Durable agent endpoint for builtin options + agent tool discovery
      - name: MASTRA_AGENT_API_BASE_URL
        value: "http://durable-agent.workflow-builder.svc.cluster.local:8001"
      # Auth configuration for ingress access
      - name: NEXT_PUBLIC_APP_URL
        value: "https://workflow-builder.cnoe.localtest.me:8443"
      - name: BETTER_AUTH_URL
        value: "https://workflow-builder.cnoe.localtest.me:8443"
      # Auth providers (enables social login buttons in UI)
      - name: NEXT_PUBLIC_AUTH_PROVIDERS
        value: "email,github,google"
      - name: NEXT_PUBLIC_GITHUB_CLIENT_ID
        value: "Ov23lixcpFfGjGtsNCxC"
      - name: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        value: "875421392000-2u0qcvoa6sc2vpisl0v8ah5h4drrljvr.apps.googleusercontent.com"
      # fn-activepieces internal URL (dev override for dynamic dropdown options)
      - name: FN_ACTIVEPIECES_URL
        value: "http://fn-activepieces.workflow-builder.svc.cluster.local"
      # AP_ENCRYPTION_KEY is provided by envFrom secretRef: workflow-builder-secrets
      # Do NOT override it here â€” DevSpace inherits the base deployment's envFrom

    # Add Dapr sidecar annotations for config/secret access
    # Note: DevSpace patches are applied to pod spec, not metadata
    # Dapr annotations must be added via kubectl after devspace starts
