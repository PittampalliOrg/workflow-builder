# DevSpace Development Container
# Full-featured development environment with all build tools
# Runs as non-root user (UID 1000) to allow Dapr sidecar coexistence
#
# Based on Node.js with additional development dependencies

FROM node:22-bookworm

# Install system dependencies for development and Claude Code tools
RUN apt-get update && apt-get install -y \
    # Version control
    git \
    openssh-client \
    gnupg \
    # Claude Code tools (Grep, file search, web fetch)
    ripgrep \
    fd-find \
    curl \
    wget \
    jq \
    # Shell utilities
    bash-completion \
    less \
    tree \
    vim-tiny \
    # Process management
    screen \
    procps \
    # Certificates for HTTPS
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    # Create symlinks for common tool names
    && ln -sf /usr/bin/fdfind /usr/bin/fd

# The node:22 image already has user 'node' with UID 1000
# Create and configure /app directory with proper ownership
# Also create /.devspace for devspace restart helper signal file
RUN mkdir -p /app && \
    chown -R node:node /app && \
    mkdir -p /.devspace && \
    chown -R node:node /.devspace

# Enable corepack for pnpm (runs as root for system-wide setup)
RUN corepack enable && \
    corepack prepare pnpm@9.12.3 --activate

# Ensure npm/node directories are accessible
RUN mkdir -p /home/node/.npm && \
    chown -R node:node /home/node/.npm

WORKDIR /app

# Switch to non-root 'node' user (UID 1000)
USER node

# Set environment for development
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# The actual source code is mounted via devspace sync
# CMD is overridden by devspace.yaml command
CMD ["tail", "-f", "/dev/null"]
