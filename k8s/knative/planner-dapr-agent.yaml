# Kubernetes Deployment for Planner Dapr Agent
#
# Replaces both planner-sdk-agent and planner-orchestrator.
# This service uses OpenAI Agents SDK for planning and execution
# with Dapr workflow orchestration and Agent Sandbox isolation.
#
# Features:
#   - Repository cloning (/clone)
#   - AI-powered planning (/plan)
#   - Sandboxed execution (/execute)
#   - Full multi-step Dapr workflow (/workflow/dapr)
#   - SSE event streaming (/workflows/{id}/stream)
#
# Prerequisites:
# - Dapr installed with workflow support
# - Redis for Dapr workflow state store
# - Agent Sandbox infrastructure in agent-sandbox namespace
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: planner-dapr-agent
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-dapr-agent
    app.kubernetes.io/component: planner
    app.kubernetes.io/part-of: workflow-builder
    app.kubernetes.io/runtime: python
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: planner-dapr-agent
  template:
    metadata:
      labels:
        app.kubernetes.io/name: planner-dapr-agent
        azure.workload.identity/use: "true"
      annotations:
        # Enable Dapr sidecar injection
        dapr.io/enabled: "true"
        dapr.io/app-id: "planner-dapr-agent"
        dapr.io/app-port: "8000"
        dapr.io/app-protocol: "http"
        dapr.io/log-level: "info"
        dapr.io/enable-metrics: "true"
        dapr.io/enable-api-logging: "true"
        # Enable Dapr workflow feature
        dapr.io/enable-workflow: "true"
        # Dapr sidecar resource settings
        dapr.io/sidecar-cpu-request: "100m"
        dapr.io/sidecar-cpu-limit: "300m"
        dapr.io/sidecar-memory-request: "250Mi"
        dapr.io/sidecar-memory-limit: "1000Mi"
        # Enable graceful shutdown for workflow continuity
        dapr.io/graceful-shutdown-seconds: "60"
        # Component scoping
        dapr.io/config: "planner-dapr-agent-config"
        # Placement service - needed for workflow actors
        dapr.io/placement-host-address: "dapr-placement-server.dapr-system.svc.cluster.local:50005"
    spec:
      securityContext:
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: planner-dapr-agent
      automountServiceAccountToken: true
      containers:
        - name: planner-dapr-agent
          image: gitea.cnoe.localtest.me:8443/giteaadmin/planner-dapr-agent:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: PORT
              value: "8000"
            - name: LOG_LEVEL
              value: "INFO"
            # Dapr configuration
            - name: DAPR_HOST
              value: "localhost"
            - name: DAPR_HTTP_PORT
              value: "3500"
            - name: DAPR_GRPC_PORT
              value: "50001"
            - name: DAPR_SECRET_STORE
              value: "azure-keyvault"
            # Workspace directory
            - name: PLANNER_CWD
              value: "/app/workspace"
            # Cross-namespace event forwarding to ai-chatbot webhook
            - name: AI_CHATBOT_WEBHOOK_URL
              value: "http://ai-chatbot.ai-chatbot.svc.cluster.local:3000/api/webhooks/dapr/workflow-stream"
            # Agent Sandbox configuration
            - name: SANDBOX_TEMPLATE
              value: "dapr-agent"
            - name: SANDBOX_NAMESPACE
              value: "agent-sandbox"
            - name: SANDBOX_ROUTER_URL
              value: "http://sandbox-router-svc.agent-sandbox.svc.cluster.local:8080"
            # Python settings
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PYTHONDONTWRITEBYTECODE
              value: "1"
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30
---
apiVersion: v1
kind: Service
metadata:
  name: planner-dapr-agent
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-dapr-agent
spec:
  selector:
    app.kubernetes.io/name: planner-dapr-agent
  ports:
    - name: http
      port: 8000
      targetPort: 8000
      protocol: TCP
  type: ClusterIP
---
# ServiceAccount for planner-dapr-agent
apiVersion: v1
kind: ServiceAccount
metadata:
  name: planner-dapr-agent
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-dapr-agent
  annotations:
    # Azure Workload Identity for accessing Azure Key Vault (OpenAI API key)
    azure.workload.identity/client-id: "1140d9c2-62f6-4857-94c2-7e0e6c64e562"
    azure.workload.identity/tenant-id: "0c4da9c5-40ea-4e7d-9c7a-e7308d4f8e38"
---
# Dapr Configuration for planner-dapr-agent
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: planner-dapr-agent-config
  namespace: workflow-builder
spec:
  # Enable distributed tracing
  tracing:
    samplingRate: "1"
    zipkin:
      endpointAddress: "http://jaeger-collector.observability.svc.cluster.local:9411/api/v2/spans"
  # Enable mTLS
  mtls:
    enabled: true
    workloadCertTTL: "24h"
    allowedClockSkew: "15m"
  # API access control
  accessControl:
    defaultAction: deny
    trustDomain: "public"
    policies:
      - appId: workflow-orchestrator
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
      - appId: workflow-builder
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
