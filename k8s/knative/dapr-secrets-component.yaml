# Dapr Secret Store Component for Azure Key Vault
#
# This component enables activities to retrieve API keys and credentials
# directly from Azure Key Vault without requiring users to configure
# integrations in the UI.
#
# Secrets are fetched automatically based on the integration type:
# - openai-api-key → OPENAI_API_KEY
# - anthropic-api-key → ANTHROPIC_API_KEY
# - slack-bot-token → SLACK_BOT_TOKEN
# - github-token → GITHUB_TOKEN
# etc.
#
# Prerequisites:
# - Azure Key Vault created with secrets added
# - Workload Identity configured on the cluster
# - ServiceAccount annotated with client ID
---
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: azure-keyvault
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: azure-keyvault
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: workflow-builder
# Component scoping - only activity-executor can access secrets
# This follows the principle of least privilege
scopes:
  - activity-executor
spec:
  type: secretstores.azure.keyvault
  version: v1
  metadata:
    # Azure Key Vault name - configure per environment
    - name: vaultName
      value: "workflow-builder-kv"
    # Use Azure Workload Identity for authentication
    # The ServiceAccount should be annotated with:
    # azure.workload.identity/client-id: <CLIENT_ID>
    - name: azureClientId
      secretKeyRef:
        name: azure-credentials
        key: client-id
    # Optional: Azure tenant ID (auto-detected if using workload identity)
    - name: azureTenantId
      secretKeyRef:
        name: azure-credentials
        key: tenant-id
---
# Alternative: Local development secrets store using Kubernetes secrets
# Uncomment this for local development without Azure Key Vault
#
# apiVersion: dapr.io/v1alpha1
# kind: Component
# metadata:
#   name: local-secrets
#   namespace: workflow-builder
# spec:
#   type: secretstores.kubernetes
#   version: v1
#   metadata: []
---
# ConfigMap for secret mappings
# Maps integration types to their secret key names in Key Vault
apiVersion: v1
kind: ConfigMap
metadata:
  name: dapr-secret-mappings
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: dapr-secret-mappings
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: workflow-builder
data:
  # Format: integration-type -> "ENV_VAR:secret-key"
  # Multiple mappings per integration are comma-separated
  ai-gateway: "OPENAI_API_KEY:openai-api-key,ANTHROPIC_API_KEY:anthropic-api-key"
  slack: "SLACK_BOT_TOKEN:slack-bot-token"
  github: "GITHUB_TOKEN:github-token"
  resend: "RESEND_API_KEY:resend-api-key"
  stripe: "STRIPE_SECRET_KEY:stripe-secret-key"
  linear: "LINEAR_API_KEY:linear-api-key"
  firecrawl: "FIRECRAWL_API_KEY:firecrawl-api-key"
  perplexity: "PERPLEXITY_API_KEY:perplexity-api-key"
  clerk: "CLERK_SECRET_KEY:clerk-secret-key"
  fal: "FAL_KEY:fal-api-key"
  webflow: "WEBFLOW_API_TOKEN:webflow-api-token"
  superagent: "SUPERAGENT_API_KEY:superagent-api-key"
