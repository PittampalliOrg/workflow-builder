# Kubernetes Deployment for Workflow Orchestrator
#
# The orchestrator runs as a standard Kubernetes Deployment (not Knative)
# because it needs to maintain the Dapr workflow runtime continuously.
# The workflow runtime holds workflow state and processes activities.
#
# Prerequisites:
# - Dapr installed in the cluster
# - Redis for Dapr workflow state store
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workflow-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: workflow-orchestrator
    app.kubernetes.io/component: orchestrator
    app.kubernetes.io/part-of: workflow-builder
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: workflow-orchestrator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: workflow-orchestrator
        azure.workload.identity/use: "true"
      annotations:
        # Enable Dapr sidecar injection
        dapr.io/enabled: "true"
        dapr.io/app-id: "workflow-orchestrator"
        dapr.io/app-port: "8080"
        dapr.io/app-protocol: "http"
        dapr.io/log-level: "info"
        dapr.io/enable-metrics: "true"
        dapr.io/enable-api-logging: "true"
        # Enable Dapr workflow feature
        dapr.io/enable-workflow: "true"
        # Dapr sidecar resource settings (production best practices)
        dapr.io/sidecar-cpu-request: "100m"
        dapr.io/sidecar-cpu-limit: "300m"
        dapr.io/sidecar-memory-request: "250Mi"
        dapr.io/sidecar-memory-limit: "1000Mi"
        # Enable graceful shutdown for workflow continuity
        dapr.io/graceful-shutdown-seconds: "60"
        # Component scoping - only allow access to needed components
        dapr.io/config: "workflow-orchestrator-config"
        # Placement service - needed for workflow actors
        dapr.io/placement-host-address: "dapr-placement-server.dapr-system.svc.cluster.local:50005"
    spec:
      # Pod security context
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      # Service account with minimal permissions
      serviceAccountName: workflow-orchestrator
      # Required for Dapr sidecar to access Kubernetes API
      automountServiceAccountToken: true
      containers:
        - name: workflow-orchestrator
          image: gitea.cnoe.localtest.me:8443/giteaadmin/workflow-orchestrator:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "8080"
            - name: HOST
              value: "0.0.0.0"
            - name: LOG_LEVEL
              value: "info"
            # Dapr configuration
            - name: DAPR_HOST
              value: "localhost"
            - name: DAPR_HTTP_PORT
              value: "3500"
            - name: DAPR_GRPC_PORT
              value: "50001"
            # Activity executor app ID for Dapr service invocation
            # Format: {app-id}.{namespace} for cross-namespace invocation
            - name: ACTIVITY_EXECUTOR_APP_ID
              value: "activity-executor.activity-executor"
            # Dapr Configuration Store settings
            - name: DAPR_CONFIG_STORE
              value: "azureappconfig"
            - name: CONFIG_LABEL
              value: "workflow-builder"
            # GOMEMLIMIT for Dapr sidecar - set to 90% of memory limit
            # This helps prevent OOM by triggering GC earlier
            - name: GOMEMLIMIT
              value: "900MiB"
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          securityContext:
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30
---
apiVersion: v1
kind: Service
metadata:
  name: workflow-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: workflow-orchestrator
spec:
  selector:
    app.kubernetes.io/name: workflow-orchestrator
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
  type: ClusterIP
---
# ServiceAccount for workflow-orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: workflow-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: workflow-orchestrator
  annotations:
    # Azure Workload Identity for accessing Azure App Configuration and Key Vault
    # Uses the same identity as external-secrets (must have App Configuration Data Reader role)
    azure.workload.identity/client-id: "1140d9c2-62f6-4857-94c2-7e0e6c64e562"
    azure.workload.identity/tenant-id: "0c4da9c5-40ea-4e7d-9c7a-e7308d4f8e38"
---
# Dapr Configuration for workflow-orchestrator
# Defines component scoping and tracing settings
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: workflow-orchestrator-config
  namespace: workflow-builder
spec:
  # Enable distributed tracing
  tracing:
    samplingRate: "1"
    zipkin:
      endpointAddress: "http://jaeger-collector.observability.svc.cluster.local:9411/api/v2/spans"
  # Enable mTLS (default, but explicit for clarity)
  mtls:
    enabled: true
    workloadCertTTL: "24h"
    allowedClockSkew: "15m"
  # API access control
  accessControl:
    defaultAction: deny
    trustDomain: "public"
    policies:
      - appId: workflow-builder
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
      - appId: activity-executor
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
---
# Dapr Component: Workflow State Store
# Uses Redis to persist workflow state durably
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: workflowstatestore
  namespace: workflow-builder
# Component scoping - only workflow-orchestrator can access
scopes:
  - workflow-orchestrator
spec:
  type: state.redis
  version: v1
  metadata:
    # Use Redis from ai-platform-engineering namespace
    - name: redisHost
      value: "redis-service.dapr-agents.svc.cluster.local:6379"
    - name: redisPassword
      value: ""
    - name: actorStateStore
      value: "true"
    # Enable workflow state storage
    - name: ttlInSeconds
      value: "86400"  # 24 hour TTL for completed workflows
---
# Dapr Component: Pub/Sub for workflow events
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: workflowpubsub
  namespace: workflow-builder
# Component scoping - both orchestrator and activity-executor can publish/subscribe
scopes:
  - workflow-orchestrator
  - activity-executor
spec:
  type: pubsub.redis
  version: v1
  metadata:
    # Use Redis from ai-platform-engineering namespace
    - name: redisHost
      value: "redis-service.dapr-agents.svc.cluster.local:6379"
    - name: redisPassword
      value: ""
---
# Dapr Component: Azure App Configuration
# Provides dynamic configuration from Azure App Configuration
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: azureappconfig
  namespace: workflow-builder
# Component scoping - only workflow-orchestrator can access
scopes:
  - workflow-orchestrator
spec:
  type: configuration.azure.appconfig
  version: v1
  metadata:
    # Azure App Configuration endpoint
    - name: host
      value: "https://rg3-app-config.azconfig.io"
    # Use Azure Workload Identity for authentication
    - name: azureClientId
      value: ""
    # Filter by label to get only workflow-builder configurations
    - name: label
      value: "workflow-builder"
    # Poll interval for configuration changes
    - name: subscribePollingInterval
      value: "30s"
