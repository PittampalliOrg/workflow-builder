# Kubernetes Deployment for Planner Orchestrator
#
# The planner orchestrator runs Dapr workflows for AI-powered planning and execution.
# It can be invoked as a child workflow from workflow-orchestrator via:
#   ctx.call_child_workflow(workflow="unified_planner_workflow", app_id="planner-orchestrator")
#
# Workflow phases:
#   1. Planning: Claude SDK agent creates implementation tasks
#   2. Persist: Tasks saved to Dapr state store
#   3. Approval: Waits for human approval (external event)
#   4. Execution: Claude SDK agent implements the tasks
#
# Prerequisites:
# - Dapr installed in the cluster
# - Redis for Dapr workflow state store (shared with workflow-orchestrator)
# - planner-sdk-agent deployed for Claude SDK execution
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: planner-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-orchestrator
    app.kubernetes.io/component: orchestrator
    app.kubernetes.io/part-of: workflow-builder
    app.kubernetes.io/runtime: python
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: planner-orchestrator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: planner-orchestrator
        azure.workload.identity/use: "true"
      annotations:
        # Enable Dapr sidecar injection
        dapr.io/enabled: "true"
        dapr.io/app-id: "planner-orchestrator"
        dapr.io/app-port: "8080"
        dapr.io/app-protocol: "http"
        dapr.io/log-level: "info"
        dapr.io/enable-metrics: "true"
        dapr.io/enable-api-logging: "true"
        # Enable Dapr workflow feature
        dapr.io/enable-workflow: "true"
        # Dapr sidecar resource settings
        dapr.io/sidecar-cpu-request: "100m"
        dapr.io/sidecar-cpu-limit: "300m"
        dapr.io/sidecar-memory-request: "250Mi"
        dapr.io/sidecar-memory-limit: "1000Mi"
        # Enable graceful shutdown for workflow continuity
        dapr.io/graceful-shutdown-seconds: "60"
        # Component scoping
        dapr.io/config: "planner-orchestrator-config"
        # Placement service - needed for workflow actors
        dapr.io/placement-host-address: "dapr-placement-server.dapr-system.svc.cluster.local:50005"
    spec:
      securityContext:
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: planner-orchestrator
      automountServiceAccountToken: true
      containers:
        - name: planner-orchestrator
          image: gitea.cnoe.localtest.me:8443/giteaadmin/planner-orchestrator:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: PORT
              value: "8080"
            - name: LOG_LEVEL
              value: "INFO"
            # Dapr configuration
            - name: DAPR_HOST
              value: "localhost"
            - name: DAPR_HTTP_PORT
              value: "3500"
            - name: DAPR_GRPC_PORT
              value: "50001"
            # Planning agent service (Dapr app-id)
            - name: PLAN_SERVICE_APP_ID
              value: "planner-dapr-agent"
            # Execution agent service (Dapr app-id)
            - name: EXEC_SERVICE_APP_ID
              value: "planner-dapr-agent"
            # State store name (shared with workflow-orchestrator)
            - name: STATESTORE_NAME
              value: "workflowstatestore"
            # Python settings
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PYTHONDONTWRITEBYTECODE
              value: "1"
            # GOMEMLIMIT for Dapr sidecar
            - name: GOMEMLIMIT
              value: "900MiB"
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30
---
apiVersion: v1
kind: Service
metadata:
  name: planner-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-orchestrator
spec:
  selector:
    app.kubernetes.io/name: planner-orchestrator
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
  type: ClusterIP
---
# ServiceAccount for planner-orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: planner-orchestrator
  namespace: workflow-builder
  labels:
    app.kubernetes.io/name: planner-orchestrator
  annotations:
    # Azure Workload Identity for accessing Azure Key Vault (Anthropic API key)
    azure.workload.identity/client-id: "1140d9c2-62f6-4857-94c2-7e0e6c64e562"
    azure.workload.identity/tenant-id: "0c4da9c5-40ea-4e7d-9c7a-e7308d4f8e38"
---
# Dapr Configuration for planner-orchestrator
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: planner-orchestrator-config
  namespace: workflow-builder
spec:
  # Enable distributed tracing
  tracing:
    samplingRate: "1"
    zipkin:
      endpointAddress: "http://jaeger-collector.observability.svc.cluster.local:9411/api/v2/spans"
  # Enable mTLS
  mtls:
    enabled: true
    workloadCertTTL: "24h"
    allowedClockSkew: "15m"
  # API access control
  accessControl:
    defaultAction: deny
    trustDomain: "public"
    policies:
      - appId: workflow-orchestrator
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
      - appId: planner-dapr-agent
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
      - appId: workflow-builder
        defaultAction: allow
        trustDomain: "public"
        namespace: "workflow-builder"
